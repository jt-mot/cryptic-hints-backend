<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guardian Cryptic Crossword - Cryptic Hints</title>
    <meta name="description" content="Solve this Guardian cryptic crossword with progressive hints. Get help from definition only to full explanation. Interactive grid with auto-fill crossings.">
    <meta property="og:title" content="Guardian Cryptic Crossword - Cryptic Hints">
    <meta property="og:description" content="Solve Guardian cryptic crosswords with four levels of progressive hints.">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Cryptic Hints">
    <meta name="twitter:card" content="summary">
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=__GA_TRACKING_ID__"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', '__GA_TRACKING_ID__');
    </script>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background: #f5f7fa;
            color: #1a1a2e;
        }

        .header {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            position: sticky;
            top: 0;
            z-index: 200;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-center {
            text-align: center;
            flex: 1;
        }

        .header-spacer {
            width: 80px;
        }

        .home-link {
            display: flex;
            align-items: center;
            gap: 8px;
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            padding: 8px 12px;
            border-radius: 6px;
            transition: all 0.2s ease;
            width: 80px;
        }

        .home-link:hover {
            color: #fff;
            background: rgba(255,255,255,0.1);
        }

        .home-link svg {
            flex-shrink: 0;
        }

        h1 {
            margin: 0 0 8px 0;
            color: #fff;
            font-size: 26px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .puzzle-info {
            color: rgba(255,255,255,0.8);
            font-size: 14px;
        }

        .progress-bar {
            max-width: 300px;
            margin: 12px auto 0;
            height: 6px;
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ade80, #22c55e);
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 3px;
        }

        .progress-text {
            color: rgba(255,255,255,0.7);
            font-size: 11px;
            margin-top: 4px;
        }

        .main-container {
            display: flex;
            max-width: 1400px;
            margin: 0 auto;
            gap: 0;
        }

        /* Grid Sidebar - Fixed */
        .grid-sidebar {
            width: 380px;
            background: #fff;
            box-shadow: 4px 0 12px rgba(0,0,0,0.08);
            position: sticky;
            top: 100px;
            height: calc(100vh - 100px);
            overflow-y: auto;
            padding: 20px;
        }

        .grid-title {
            font-size: 11px;
            font-weight: 700;
            color: #94a3b8;
            margin-bottom: 15px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }

        .grid-wrapper {
            text-align: center;
            overflow: auto;
        }

        .crossword-grid {
            display: inline-grid;
            gap: 0;
            border: 3px solid #1a1a2e;
            background: #1a1a2e;
            margin: 0 auto;
            border-radius: 4px;
            overflow: hidden;
        }

        .cell {
            width: 24px;
            height: 24px;
            border: 1px solid #cbd5e1;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 12px;
            font-family: 'Arial', sans-serif;
            background: #fff;
            transition: background 0.15s ease;
        }

        .cell.white:hover {
            background: #f1f5f9;
        }

        .cell.black {
            background: #1a1a2e;
            border-color: #1a1a2e;
        }

        .cell.filled {
            color: #2563eb;
            font-weight: 700;
        }

        .cell.highlighted {
            background: #dbeafe !important;
        }

        .cell-number {
            position: absolute;
            top: 1px;
            left: 2px;
            font-size: 7px;
            font-weight: 600;
            color: #64748b;
        }

        .cell-letter {
            margin-top: 2px;
            font-size: 12px;
        }

        /* Clues Section */
        .clues-main {
            flex: 1;
            padding: 30px 40px;
            overflow-y: auto;
        }

        .direction-section {
            margin-bottom: 50px;
        }

        .direction-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 24px;
            color: #1a1a2e;
            padding-bottom: 12px;
            border-bottom: 3px solid #3b82f6;
            display: inline-block;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .clue-item {
            margin-bottom: 24px;
            padding: 24px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            transition: all 0.2s ease;
            border: 1px solid #e2e8f0;
        }

        .clue-item:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            transform: translateY(-1px);
        }

        .clue-item.selected {
            box-shadow: 0 0 0 3px #3b82f6, 0 4px 16px rgba(59,130,246,0.2);
            background: #f0f7ff;
            border-color: #3b82f6;
        }

        .clue-item.completed {
            border-left: 4px solid #22c55e;
        }

        .clue-header {
            margin-bottom: 16px;
        }

        .clue-number {
            display: inline-block;
            min-width: 40px;
            font-weight: 800;
            color: #3b82f6;
            font-size: 18px;
        }

        .clue-text {
            font-size: 17px;
            color: #334155;
            line-height: 1.7;
        }

        .enumeration {
            color: #94a3b8;
            font-size: 14px;
            margin-left: 8px;
            font-weight: 500;
        }

        /* Answer Input */
        .answer-section {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #e2e8f0;
        }

        .answer-label {
            font-size: 12px;
            font-weight: 600;
            color: #64748b;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .answer-boxes {
            display: flex;
            gap: 6px;
            margin-bottom: 14px;
            flex-wrap: wrap;
        }

        .answer-box {
            width: 36px;
            height: 36px;
            border: 2px solid #cbd5e1;
            border-radius: 6px;
            text-align: center;
            font-size: 18px;
            font-weight: 700;
            text-transform: uppercase;
            outline: none;
            font-family: 'Arial', sans-serif;
            transition: all 0.15s ease;
        }

        .answer-box:focus {
            border-color: #3b82f6;
            background: #eff6ff;
            box-shadow: 0 0 0 3px rgba(59,130,246,0.2);
        }

        .answer-box.correct {
            background: #dcfce7;
            border-color: #22c55e;
            color: #166534;
        }

        .answer-box.prefilled {
            background: #fef9c3;
            border-color: #eab308;
            color: #a16207;
        }

        .answer-box.separator {
            width: 12px;
            border: none;
            pointer-events: none;
        }

        .check-button {
            padding: 10px 24px;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(37,99,235,0.3);
        }

        .check-button:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(37,99,235,0.4);
        }

        .check-button.correct {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            cursor: default;
            box-shadow: 0 2px 8px rgba(34,197,94,0.3);
        }

        /* Hints - Progressive colors from easy (green) to revealing (red) */
        .hints-section {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #e2e8f0;
        }

        .hints-label {
            font-size: 12px;
            font-weight: 600;
            color: #64748b;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .hint-button {
            display: block;
            width: 100%;
            padding: 10px 16px;
            margin-bottom: 8px;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            text-align: left;
            transition: all 0.2s ease;
        }

        /* Hint 1 - Green (least revealing) */
        .hint-button.hint-1 {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
        }
        .hint-button.hint-1:hover {
            background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
        }
        .hint-button.hint-1.revealed {
            background: #86efac;
            color: #166534;
        }

        /* Hint 2 - Yellow/Amber */
        .hint-button.hint-2 {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        .hint-button.hint-2:hover {
            background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
        }
        .hint-button.hint-2.revealed {
            background: #fde68a;
            color: #92400e;
        }

        /* Hint 3 - Orange */
        .hint-button.hint-3 {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
        }
        .hint-button.hint-3:hover {
            background: linear-gradient(135deg, #ea580c 0%, #c2410c 100%);
        }
        .hint-button.hint-3.revealed {
            background: #fed7aa;
            color: #9a3412;
        }

        /* Hint 4 - Red (most revealing) */
        .hint-button.hint-4 {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        .hint-button.hint-4:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        }
        .hint-button.hint-4.revealed {
            background: #fecaca;
            color: #991b1b;
        }

        .hint-text {
            margin-top: 8px;
            margin-bottom: 12px;
            padding: 14px 16px;
            background: #f8fafc;
            border-left: 4px solid #cbd5e1;
            border-radius: 6px;
            font-size: 15px;
            line-height: 1.7;
            display: none;
            color: #334155;
        }

        .hint-text.visible {
            display: block;
            animation: slideDown 0.2s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .feedback {
            margin-top: 12px;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            display: none;
        }

        .feedback.visible {
            display: block;
            animation: slideDown 0.2s ease;
        }

        .feedback.correct {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #86efac;
        }

        .feedback.incorrect {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        /* Loading State */
        .loading-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 80px 20px;
            text-align: center;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #e2e8f0;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-state p {
            color: #64748b;
            font-size: 16px;
            margin: 0;
        }

        .loading-state .loading-title {
            color: #1a1a2e;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        /* Mobile View Toggle */
        .mobile-toggle {
            display: none;
            position: sticky;
            top: 0;
            z-index: 100;
            background: #fff;
            padding: 12px 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            gap: 8px;
        }

        .mobile-toggle button {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            background: #fff;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            color: #64748b;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .mobile-toggle button.active {
            background: #3b82f6;
            border-color: #3b82f6;
            color: #fff;
        }

        .mobile-toggle button:not(.active):hover {
            border-color: #3b82f6;
            color: #3b82f6;
        }

        @media (max-width: 768px) {
            .mobile-toggle {
                display: flex;
            }

            .main-container {
                flex-direction: column;
            }

            /* Hide inactive view on mobile */
            .main-container.show-grid .clues-main {
                display: none;
            }

            .main-container.show-clues .grid-sidebar {
                display: none !important;
            }

            .grid-sidebar {
                width: 100%;
                position: relative;
                height: auto;
                top: 0;
                padding: 16px;
                min-height: calc(100vh - 200px);
            }

            .clues-main {
                padding: 16px;
            }

            /* Larger grid cells for touch */
            .cell {
                width: 28px;
                height: 28px;
            }

            .crossword-grid {
                transform: none;
            }

            .cell-number {
                font-size: 8px;
            }

            .cell-letter {
                font-size: 14px;
            }

            .clue-item {
                padding: 16px;
            }

            .clue-text {
                font-size: 15px;
            }

            .answer-box {
                width: 36px;
                height: 36px;
                font-size: 18px;
            }

            .hint-button {
                padding: 12px 14px;
                font-size: 14px;
            }

            h1 {
                font-size: 18px;
            }

            .puzzle-info {
                font-size: 12px;
            }

            .header {
                padding: 12px 16px;
            }

            .home-link span {
                display: none;
            }

            .home-link {
                width: auto;
                padding: 8px;
            }

            .header-spacer {
                width: 44px;
            }
        }

        @media (max-width: 1024px) and (min-width: 769px) {
            .main-container {
                flex-direction: column;
            }

            .grid-sidebar {
                width: 100%;
                position: relative;
                height: auto;
                top: 0;
                padding: 15px;
            }

            .clues-main {
                padding: 20px;
            }

            .crossword-grid {
                transform: scale(0.85);
                transform-origin: center;
            }

            .clue-item {
                padding: 18px;
            }

            .clue-text {
                font-size: 16px;
            }
        }

        @media (max-width: 400px) {
            /* Very small phones */
            .cell {
                width: 24px;
                height: 24px;
            }

            .cell-letter {
                font-size: 12px;
            }

            .answer-box {
                width: 32px;
                height: 32px;
                font-size: 16px;
            }

            .hint-button {
                padding: 10px 12px;
                font-size: 13px;
            }
        }

        /* Anagram Helper Widget */
        .anagram-widget {
            margin-top: 20px;
            border-top: 1px solid #e2e8f0;
            padding-top: 16px;
        }
        .anagram-toggle {
            display: flex;
            align-items: center;
            gap: 6px;
            background: none;
            border: none;
            font-size: 12px;
            font-weight: 700;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            padding: 4px 0;
            width: 100%;
        }
        .anagram-toggle:hover { color: #2563eb; }
        .anagram-toggle .arrow {
            transition: transform 0.2s;
            font-size: 10px;
        }
        .anagram-toggle.open .arrow { transform: rotate(90deg); }
        .anagram-body { display: none; margin-top: 12px; }
        .anagram-body.open { display: block; }
        .anagram-input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            font-family: 'Courier New', monospace;
            letter-spacing: 2px;
            text-transform: uppercase;
            outline: none;
            transition: border-color 0.2s;
        }
        .anagram-input:focus { border-color: #2563eb; }
        .anagram-input::placeholder {
            text-transform: none;
            letter-spacing: 0;
            font-family: -apple-system, sans-serif;
            font-size: 13px;
            color: #94a3b8;
        }
        .anagram-actions {
            display: flex;
            gap: 6px;
            margin-top: 8px;
        }
        .anagram-btn {
            flex: 1;
            padding: 8px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            background: #f8fafc;
            font-size: 12px;
            font-weight: 600;
            color: #475569;
            cursor: pointer;
            transition: all 0.15s;
        }
        .anagram-btn:hover { background: #e2e8f0; }
        .anagram-result {
            margin-top: 10px;
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 20px;
            font-weight: 700;
            letter-spacing: 4px;
            text-align: center;
            color: #1e293b;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .anagram-sorted {
            margin-top: 6px;
            font-size: 11px;
            color: #94a3b8;
            text-align: center;
        }
        .anagram-guide-link {
            display: block;
            text-align: center;
            margin-top: 10px;
            font-size: 12px;
            color: #2563eb;
            text-decoration: none;
        }
        .anagram-guide-link:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <a href="/" class="home-link" title="Back to Home">
                <svg width="28" height="28" viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg">
                    <rect width="36" height="36" rx="6" fill="url(#logoGradPuzzle)"/>
                    <defs>
                        <linearGradient id="logoGradPuzzle" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" stop-color="#22c55e"/>
                            <stop offset="100%" stop-color="#16a34a"/>
                        </linearGradient>
                    </defs>
                    <rect x="3" y="3" width="9" height="9" rx="1.5" fill="white"/>
                    <rect x="13.5" y="3" width="9" height="9" rx="1.5" fill="white"/>
                    <rect x="24" y="3" width="9" height="9" rx="1.5" fill="rgba(0,0,0,0.35)"/>
                    <rect x="3" y="13.5" width="9" height="9" rx="1.5" fill="rgba(0,0,0,0.35)"/>
                    <rect x="13.5" y="13.5" width="9" height="9" rx="1.5" fill="white"/>
                    <rect x="24" y="13.5" width="9" height="9" rx="1.5" fill="white"/>
                    <rect x="3" y="24" width="9" height="9" rx="1.5" fill="white"/>
                    <rect x="13.5" y="24" width="9" height="9" rx="1.5" fill="rgba(0,0,0,0.35)"/>
                    <rect x="24" y="24" width="9" height="9" rx="1.5" fill="white"/>
                    <text x="18" y="21" text-anchor="middle" fill="#16a34a" font-size="8" font-weight="700" font-family="Arial, sans-serif">?</text>
                </svg>
                <span>Cryptic Hints</span>
            </a>
            <div class="header-center">
                <h1>Guardian Cryptic Crossword</h1>
                <div class="puzzle-info" id="puzzleInfo">Loading...</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">0 / 0 solved</div>
            </div>
            <div class="header-spacer"></div>
        </div>
    </div>

    <!-- Mobile View Toggle -->
    <div class="mobile-toggle">
        <button id="toggleGrid" class="active" onclick="showView('grid')">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/>
                <rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/>
            </svg>
            Grid
        </button>
        <button id="toggleClues" onclick="showView('clues')">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/>
                <line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/>
                <line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/>
            </svg>
            Clues
        </button>
    </div>

    <div class="main-container show-grid" id="mainContainer">
        <!-- Grid Sidebar -->
        <div class="grid-sidebar" id="gridSidebar" style="display: none;">
            <div class="grid-title">GRID</div>
            <div class="grid-wrapper">
                <div id="crosswordGrid"></div>
            </div>

            <!-- Anagram Helper -->
            <div class="anagram-widget">
                <button class="anagram-toggle" id="anagramToggle" onclick="toggleAnagram()">
                    <span class="arrow">&#9654;</span> Anagram Helper
                </button>
                <div class="anagram-body" id="anagramBody">
                    <input type="text" class="anagram-input" id="anagramInput"
                           placeholder="Type letters to rearrange..."
                           oninput="updateAnagramDisplay()">
                    <div class="anagram-actions">
                        <button class="anagram-btn" onclick="shuffleAnagram()">Shuffle</button>
                        <button class="anagram-btn" onclick="sortAnagram()">A-Z Sort</button>
                        <button class="anagram-btn" onclick="clearAnagram()">Clear</button>
                    </div>
                    <div class="anagram-result" id="anagramResult"></div>
                    <div class="anagram-sorted" id="anagramSorted"></div>
                    <a href="/guide#anagrams" target="_blank" class="anagram-guide-link">Anagram solving tips &rarr;</a>
                </div>
            </div>
        </div>
        
        <!-- Clues Main Area -->
        <div class="clues-main">
            <!-- Loading State -->
            <div class="loading-state" id="loadingState">
                <div class="loading-spinner"></div>
                <p class="loading-title">Loading puzzle...</p>
                <p>This should only take a moment</p>
            </div>

            <!-- Clues Content (hidden until loaded) -->
            <div id="cluesContent" style="display: none;">
                <div class="direction-section">
                    <h2 class="direction-title">Across</h2>
                    <div id="cluesAcross"></div>
                </div>

                <div class="direction-section">
                    <h2 class="direction-title">Down</h2>
                    <div id="cluesDown"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const puzzleNumber = window.location.pathname.split('/').pop();
        let puzzleData = null;
        let userAnswers = {}; // {clueId: 'ANSWER'}
        let gridFills = {}; // {x,y: letter}
        let hintsRevealed = {}; // {clueId: [1,2,3,4]}
        let cellToClues = {}; // {x,y: [clueIds]} - reverse mapping for click navigation
        let completedClues = new Set(); // Track solved clues for progress

        // Mobile view toggle
        function showView(view) {
            const container = document.getElementById('mainContainer');
            const gridBtn = document.getElementById('toggleGrid');
            const cluesBtn = document.getElementById('toggleClues');

            if (view === 'grid') {
                container.classList.remove('show-clues');
                container.classList.add('show-grid');
                gridBtn.classList.add('active');
                cluesBtn.classList.remove('active');
            } else {
                container.classList.remove('show-grid');
                container.classList.add('show-clues');
                cluesBtn.classList.add('active');
                gridBtn.classList.remove('active');
            }
        }

        async function loadPuzzle() {
            try {
                console.log('Loading puzzle:', puzzleNumber);
                const response = await fetch(`/api/puzzle/${puzzleNumber}`);
                puzzleData = await response.json();
                
                console.log('Puzzle data:', puzzleData);
                
                if (puzzleData.error) {
                    alert('Puzzle not found');
                    return;
                }
                
                document.getElementById('puzzleInfo').innerHTML = 
                    `#${puzzleData.puzzle_number} by ${puzzleData.setter} | ${puzzleData.date}`;
                
                // Show grid if available
                if (puzzleData.grid && puzzleData.grid.grid) {
                    console.log('Grid available, rendering...');
                    document.getElementById('gridSidebar').style.display = 'block';
                    renderGrid();
                } else {
                    console.warn('No grid data available');
                }
                
                console.log('Rendering clues...');
                renderClues();

                // Hide loading, show content
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('cluesContent').style.display = 'block';

                // Restore saved progress from localStorage
                loadProgress();

                // Initialize progress bar
                updateProgress();
            } catch (error) {
                console.error('Error:', error);
                alert('Error loading puzzle: ' + error.message);
            }
        }

        function buildCellToCluesMapping() {
            // Build reverse mapping from cell coordinates to clue IDs
            cellToClues = {};
            const clueCells = puzzleData.grid.clue_cells || {};

            for (const [clueId, cells] of Object.entries(clueCells)) {
                cells.forEach(([x, y]) => {
                    const key = `${x},${y}`;
                    if (!cellToClues[key]) {
                        cellToClues[key] = [];
                    }
                    cellToClues[key].push(clueId);
                });
            }
        }

        function renderGrid() {
            const grid = puzzleData.grid;
            const size = grid.size || 15;
            const container = document.getElementById('crosswordGrid');
            container.className = 'crossword-grid';
            container.style.gridTemplateColumns = `repeat(${size}, 22px)`;
            container.innerHTML = '';

            // Build the cell-to-clues mapping
            buildCellToCluesMapping();

            for (let y = 0; y < size; y++) {
                for (let x = 0; x < size; x++) {
                    const letter = grid.grid[y][x];
                    const number = grid.numbers[y][x];
                    const isBlack = letter === null;

                    const cell = document.createElement('div');
                    cell.className = `cell ${isBlack ? 'black' : 'white'}`;
                    cell.dataset.x = x;
                    cell.dataset.y = y;

                    if (!isBlack) {
                        if (number) {
                            const numSpan = document.createElement('span');
                            numSpan.className = 'cell-number';
                            numSpan.textContent = number;
                            cell.appendChild(numSpan);
                        }

                        const letterSpan = document.createElement('span');
                        letterSpan.className = 'cell-letter';
                        letterSpan.dataset.x = x;
                        letterSpan.dataset.y = y;

                        const key = `${x},${y}`;
                        if (gridFills[key]) {
                            letterSpan.textContent = gridFills[key];
                            cell.classList.add('filled');
                        }

                        cell.appendChild(letterSpan);

                        // Add click handler for navigation
                        cell.style.cursor = 'pointer';
                        cell.onclick = () => navigateToClue(x, y);
                    }

                    container.appendChild(cell);
                }
            }
        }

        function navigateToClue(x, y) {
            const key = `${x},${y}`;
            const clueIds = cellToClues[key];

            if (!clueIds || clueIds.length === 0) return;

            // If there are multiple clues (intersection), alternate between them
            // Use a simple toggle based on which one is currently highlighted
            let targetClueId = clueIds[0];

            if (clueIds.length > 1) {
                // Check if one is already highlighted, pick the other
                const currentHighlighted = document.querySelector('.clue-item.selected');
                if (currentHighlighted) {
                    const currentId = currentHighlighted.dataset.clueId;
                    if (currentId === clueIds[0]) {
                        targetClueId = clueIds[1];
                    }
                }
            }

            // Remove previous highlight
            document.querySelectorAll('.clue-item.selected').forEach(el => {
                el.classList.remove('selected');
            });

            // Find and scroll to the clue
            const clueElement = document.querySelector(`.clue-item[data-clue-id="${targetClueId}"]`);
            if (clueElement) {
                clueElement.classList.add('selected');

                // On mobile, switch to clues view first
                if (window.innerWidth <= 768) {
                    showView('clues');
                    // Small delay to let view switch complete before scrolling
                    setTimeout(() => {
                        clueElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 50);
                } else {
                    clueElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }

                // Also highlight the cells in the grid for this clue
                highlightClueCells(targetClueId);
            }
        }

        function highlightClueCells(clueId) {
            // Remove previous highlights
            document.querySelectorAll('.cell.highlighted').forEach(el => {
                el.classList.remove('highlighted');
            });

            // Highlight cells for this clue
            const cells = puzzleData.grid.clue_cells[clueId] || [];
            cells.forEach(([x, y]) => {
                const cell = document.querySelector(`.cell[data-x="${x}"][data-y="${y}"]`);
                if (cell) {
                    cell.classList.add('highlighted');
                }
            });
        }

        function updateGrid(clueId, answer) {
            const cells = puzzleData.grid.clue_cells[clueId] || [];
            
            cells.forEach(([x, y], index) => {
                const key = `${x},${y}`;
                gridFills[key] = answer[index];
                
                const letterSpan = document.querySelector(`.cell-letter[data-x="${x}"][data-y="${y}"]`);
                if (letterSpan) {
                    letterSpan.textContent = answer[index];
                    letterSpan.parentElement.classList.add('filled');
                }
            });
            
            // Update other clues' answer boxes that share these cells
            updateCrossFilledLetters();
        }

        function updateCrossFilledLetters() {
            puzzleData.clues.forEach(clue => {
                const clueId = `${clue.clue_number}-${clue.direction}`;
                const cells = puzzleData.grid.clue_cells[clueId] || [];

                cells.forEach(([ x, y], index) => {
                    const key = `${x},${y}`;
                    if (gridFills[key]) {
                        const input = document.querySelector(
                            `.answer-box[data-clue-id="${clueId}"][data-index="${index}"]`
                        );
                        if (input && !input.value && !input.classList.contains('correct')) {
                            input.value = gridFills[key];
                            input.classList.add('prefilled');
                            // Don't disable - let user edit if needed
                        }
                    }
                });
            });
        }

        function renderClues() {
            const acrossClues = puzzleData.clues.filter(c => c.direction === 'across');
            const downClues = puzzleData.clues.filter(c => c.direction === 'down');
            
            document.getElementById('cluesAcross').innerHTML = acrossClues
                .map(clue => createClueElement(clue))
                .join('');
            
            document.getElementById('cluesDown').innerHTML = downClues
                .map(clue => createClueElement(clue))
                .join('');
            
            setupEventListeners();
        }

        function createClueElement(clue) {
            const clueId = `${clue.clue_number}-${clue.direction}`;
            const length = parseInt(clue.enumeration.replace(/[^0-9]/g, '')) || clue.answer.length;

            // Strip enumeration from clue text if it's already there (avoid duplication)
            let displayClueText = clue.clue_text;
            const enumPattern = /\s*\([0-9,\-\s]+\)\s*$/;
            displayClueText = displayClueText.replace(enumPattern, '');

            // Parse enumeration for separators
            const enumParts = clue.enumeration.match(/\d+/g) || [clue.answer.length];
            let boxesHTML = '';
            let totalBoxes = 0;
            
            enumParts.forEach((part, partIndex) => {
                const count = parseInt(part);
                for (let i = 0; i < count; i++) {
                    boxesHTML += `<input type="text" maxlength="1" 
                        class="answer-box" 
                        data-clue-id="${clueId}" 
                        data-index="${totalBoxes}"
                        oninput="handleAnswerInput('${clueId}', ${totalBoxes}, this.value)"
                        onkeydown="handleAnswerKeydown(event, '${clueId}', ${totalBoxes})">`;
                    totalBoxes++;
                }
                if (partIndex < enumParts.length - 1) {
                    boxesHTML += '<div class="answer-box separator"></div>';
                }
            });
            
            return `
                <div class="clue-item" data-clue-id="${clueId}" onclick="focusClue('${clueId}', event)">
                    <div class="clue-header">
                        <div>
                            <span class="clue-number">${clue.clue_number}</span>
                            <span class="clue-text">${displayClueText}</span>
                            <span class="enumeration">(${clue.enumeration})</span>
                        </div>
                    </div>
                    
                    <div class="answer-section">
                        <div class="answer-label">Your answer:</div>
                        <div class="answer-boxes">${boxesHTML}</div>
                        <button class="check-button" onclick="checkAnswer('${clueId}', '${clue.answer}')">
                            Check Answer
                        </button>
                        <div class="feedback" id="feedback-${clueId}"></div>
                    </div>
                    
                    <div class="hints-section">
                        <div class="hints-label">Progressive Hints</div>
                        <button class="hint-button hint-1" onclick="revealHint('${clueId}', 1)">üí° Hint 1: Definition</button>
                        <div class="hint-text" id="hint-${clueId}-1">${clue.hints[0] || 'No hint available'}</div>

                        <button class="hint-button hint-2" onclick="revealHint('${clueId}', 2)">üîß Hint 2: Wordplay Type</button>
                        <div class="hint-text" id="hint-${clueId}-2">${clue.hints[1] || 'No hint available'}</div>
                        
                        <button class="hint-button hint-3" onclick="revealHint('${clueId}', 3)">üìù Hint 3: Breakdown</button>
                        <div class="hint-text" id="hint-${clueId}-3">${clue.hints[2] || 'No hint available'}</div>

                        <button class="hint-button hint-4" onclick="revealHint('${clueId}', 4)">‚úÖ Hint 4: Full Explanation</button>
                        <div class="hint-text" id="hint-${clueId}-4">${clue.hints[3] || 'No hint available'}</div>
                    </div>
                </div>
            `;
        }

        function handleAnswerInput(clueId, index, value) {
            if (value) {
                value = value.toUpperCase();
                const input = document.querySelector(
                    `.answer-box[data-clue-id="${clueId}"][data-index="${index}"]`
                );
                input.value = value;

                // Auto-advance
                const nextInput = document.querySelector(
                    `.answer-box[data-clue-id="${clueId}"][data-index="${index + 1}"]`
                );
                if (nextInput) {
                    nextInput.focus();
                }

                saveProgress();
            }
        }

        function handleAnswerKeydown(event, clueId, index) {
            if (event.key === 'Backspace') {
                const input = event.target;
                if (!input.value) {
                    const prevInput = document.querySelector(
                        `.answer-box[data-clue-id="${clueId}"][data-index="${index - 1}"]`
                    );
                    if (prevInput && !prevInput.classList.contains('correct')) {
                        prevInput.focus();
                        prevInput.value = '';
                        prevInput.classList.remove('prefilled');
                    }
                }
                saveProgress();
                return;
            }

            // Arrow left: move to previous box in same clue
            if (event.key === 'ArrowLeft') {
                event.preventDefault();
                const prev = document.querySelector(
                    `.answer-box[data-clue-id="${clueId}"][data-index="${index - 1}"]`
                );
                if (prev) prev.focus();
                return;
            }

            // Arrow right: move to next box in same clue
            if (event.key === 'ArrowRight') {
                event.preventDefault();
                const next = document.querySelector(
                    `.answer-box[data-clue-id="${clueId}"][data-index="${index + 1}"]`
                );
                if (next) next.focus();
                return;
            }

            // Tab / Shift+Tab: jump to next/previous clue's first box
            if (event.key === 'Tab') {
                const clueItems = Array.from(document.querySelectorAll('.clue-item'));
                const currentClue = document.querySelector(`.clue-item[data-clue-id="${clueId}"]`);
                const currentIdx = clueItems.indexOf(currentClue);

                const direction = event.shiftKey ? -1 : 1;
                let targetIdx = currentIdx + direction;

                // Wrap around
                if (targetIdx < 0) targetIdx = clueItems.length - 1;
                if (targetIdx >= clueItems.length) targetIdx = 0;

                const targetClue = clueItems[targetIdx];
                if (targetClue) {
                    event.preventDefault();
                    const targetClueId = targetClue.dataset.clueId;
                    const firstInput = targetClue.querySelector('.answer-box:not(.separator):not([disabled])');
                    if (firstInput) {
                        firstInput.focus();
                        targetClue.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

                        // Highlight in grid
                        document.querySelectorAll('.clue-item.selected').forEach(el => el.classList.remove('selected'));
                        targetClue.classList.add('selected');
                        highlightClueCells(targetClueId);
                    }
                }
                return;
            }

            // Arrow up/down: move to same-position box in previous/next clue
            if (event.key === 'ArrowUp' || event.key === 'ArrowDown') {
                event.preventDefault();
                const clueItems = Array.from(document.querySelectorAll('.clue-item'));
                const currentClue = document.querySelector(`.clue-item[data-clue-id="${clueId}"]`);
                const currentIdx = clueItems.indexOf(currentClue);

                const direction = event.key === 'ArrowUp' ? -1 : 1;
                let targetIdx = currentIdx + direction;
                if (targetIdx < 0 || targetIdx >= clueItems.length) return;

                const targetClue = clueItems[targetIdx];
                if (targetClue) {
                    const targetClueId = targetClue.dataset.clueId;
                    // Try same index, fall back to first available box
                    let targetInput = targetClue.querySelector(
                        `.answer-box[data-index="${index}"]:not(.separator):not([disabled])`
                    );
                    if (!targetInput) {
                        targetInput = targetClue.querySelector('.answer-box:not(.separator):not([disabled])');
                    }
                    if (targetInput) {
                        targetInput.focus();
                        targetClue.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

                        document.querySelectorAll('.clue-item.selected').forEach(el => el.classList.remove('selected'));
                        targetClue.classList.add('selected');
                        highlightClueCells(targetClueId);
                    }
                }
                return;
            }
        }

        function checkAnswer(clueId, correctAnswer) {
            const inputs = document.querySelectorAll(`.answer-box[data-clue-id="${clueId}"]:not(.separator)`);
            let userAnswer = '';

            inputs.forEach(input => {
                userAnswer += input.value.toUpperCase() || '';
            });

            const feedback = document.getElementById(`feedback-${clueId}`);

            if (userAnswer === correctAnswer.toUpperCase()) {
                feedback.textContent = '‚úì Correct!';
                feedback.className = 'feedback correct visible';

                // Fill grid
                updateGrid(clueId, correctAnswer.toUpperCase());

                // Mark inputs as correct
                inputs.forEach(input => {
                    input.classList.add('correct');
                    input.disabled = true;
                });

                // Update button
                const button = document.querySelector(`.check-button[onclick*="${clueId}"]`);
                if (button) {
                    button.textContent = '‚úì Correct';
                    button.classList.add('correct');
                    button.disabled = true;
                }

                // Mark clue as completed
                const clueItem = document.querySelector(`.clue-item[data-clue-id="${clueId}"]`);
                if (clueItem) {
                    clueItem.classList.add('completed');
                }

                // Track progress
                completedClues.add(clueId);
                updateProgress();
                saveProgress();

            } else {
                feedback.textContent = '‚úó Not quite right. Try again or use a hint!';
                feedback.className = 'feedback incorrect visible';

                setTimeout(() => {
                    feedback.classList.remove('visible');
                }, 3000);
            }
        }

        function updateProgress() {
            const total = puzzleData ? puzzleData.clues.length : 0;
            const solved = completedClues.size;
            const percent = total > 0 ? (solved / total) * 100 : 0;

            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');

            if (progressFill) {
                progressFill.style.width = `${percent}%`;
            }
            if (progressText) {
                progressText.textContent = `${solved} / ${total} solved`;
            }
        }

        function revealHint(clueId, level) {
            const hint = document.getElementById(`hint-${clueId}-${level}`);
            hint.classList.add('visible');

            // Mark button as revealed
            const buttons = document.querySelectorAll(`button[onclick*="${clueId}"]`);
            if (buttons[level - 1]) {
                buttons[level - 1].classList.add('revealed');
            }

            // Track revealed hints
            if (!hintsRevealed[clueId]) hintsRevealed[clueId] = [];
            if (!hintsRevealed[clueId].includes(level)) {
                hintsRevealed[clueId].push(level);
            }
            saveProgress();
        }

        function focusClue(clueId, event) {
            // Don't steal focus from inputs, buttons, or hints the user clicked
            if (event && (event.target.tagName === 'INPUT' || event.target.tagName === 'BUTTON'
                || event.target.classList.contains('hint-text'))) return;

            const clueItem = document.querySelector(`.clue-item[data-clue-id="${clueId}"]`);
            if (!clueItem) return;

            // Focus first available input
            const firstInput = clueItem.querySelector('.answer-box:not(.separator):not([disabled])');
            if (firstInput) firstInput.focus();

            // Highlight
            document.querySelectorAll('.clue-item.selected').forEach(el => el.classList.remove('selected'));
            clueItem.classList.add('selected');
            highlightClueCells(clueId);
        }

        function setupEventListeners() {
            // Auto-focus first answer box when scrolling to clue
        }

        // ============================================================
        // LocalStorage Progress Save/Load
        // ============================================================

        function getStorageKey() {
            return `cryptic-hints-puzzle-${puzzleNumber}`;
        }

        function saveProgress() {
            try {
                // Collect current input values (not just gridFills, also unsolved typed letters)
                const inputValues = {};
                document.querySelectorAll('.answer-box:not(.separator)').forEach(input => {
                    const clueId = input.dataset.clueId;
                    const index = input.dataset.index;
                    if (input.value) {
                        if (!inputValues[clueId]) inputValues[clueId] = {};
                        inputValues[clueId][index] = input.value.toUpperCase();
                    }
                });

                const state = {
                    gridFills: gridFills,
                    completedClues: Array.from(completedClues),
                    hintsRevealed: hintsRevealed,
                    inputValues: inputValues,
                    savedAt: new Date().toISOString()
                };

                localStorage.setItem(getStorageKey(), JSON.stringify(state));
            } catch (e) {
                console.warn('Could not save progress:', e);
            }
        }

        function loadProgress() {
            try {
                const saved = localStorage.getItem(getStorageKey());
                if (!saved) return;

                const state = JSON.parse(saved);

                // Restore gridFills
                if (state.gridFills) {
                    gridFills = state.gridFills;
                }

                // Restore completed clues
                if (state.completedClues) {
                    completedClues = new Set(state.completedClues);
                }

                // Restore hints revealed tracking
                if (state.hintsRevealed) {
                    hintsRevealed = state.hintsRevealed;
                }

                // Restore input values into answer boxes
                if (state.inputValues) {
                    for (const [clueId, indices] of Object.entries(state.inputValues)) {
                        for (const [index, value] of Object.entries(indices)) {
                            const input = document.querySelector(
                                `.answer-box[data-clue-id="${clueId}"][data-index="${index}"]`
                            );
                            if (input) {
                                input.value = value;
                            }
                        }
                    }
                }

                // Restore completed clue visual state
                completedClues.forEach(clueId => {
                    const clueItem = document.querySelector(`.clue-item[data-clue-id="${clueId}"]`);
                    if (clueItem) clueItem.classList.add('completed');

                    // Mark inputs as correct and disabled
                    const inputs = document.querySelectorAll(`.answer-box[data-clue-id="${clueId}"]:not(.separator)`);
                    inputs.forEach(input => {
                        input.classList.add('correct');
                        input.disabled = true;
                    });

                    // Mark check button
                    const button = document.querySelector(`.check-button[onclick*="${clueId}"]`);
                    if (button) {
                        button.textContent = '‚úì Correct';
                        button.classList.add('correct');
                        button.disabled = true;
                    }

                    // Show feedback
                    const feedback = document.getElementById(`feedback-${clueId}`);
                    if (feedback) {
                        feedback.textContent = '‚úì Correct!';
                        feedback.className = 'feedback correct visible';
                    }
                });

                // Restore revealed hints
                if (state.hintsRevealed) {
                    for (const [clueId, levels] of Object.entries(state.hintsRevealed)) {
                        levels.forEach(level => {
                            const hint = document.getElementById(`hint-${clueId}-${level}`);
                            if (hint) hint.classList.add('visible');

                            const buttons = document.querySelectorAll(`button[onclick*="${clueId}"]`);
                            if (buttons[level - 1]) {
                                buttons[level - 1].classList.add('revealed');
                            }
                        });
                    }
                }

                // Re-render grid with restored fills
                if (puzzleData.grid && puzzleData.grid.grid) {
                    renderGrid();
                }

                // Update progress bar
                updateProgress();

                console.log(`Restored progress: ${completedClues.size} clues solved`);
            } catch (e) {
                console.warn('Could not load progress:', e);
            }
        }

        // ============================================================
        // Anagram Helper
        // ============================================================

        function toggleAnagram() {
            const btn = document.getElementById('anagramToggle');
            const body = document.getElementById('anagramBody');
            btn.classList.toggle('open');
            body.classList.toggle('open');
            if (body.classList.contains('open')) {
                document.getElementById('anagramInput').focus();
            }
        }

        function updateAnagramDisplay() {
            const raw = document.getElementById('anagramInput').value.replace(/[^a-zA-Z]/g, '').toUpperCase();
            const result = document.getElementById('anagramResult');
            const sorted = document.getElementById('anagramSorted');
            if (!raw) {
                result.textContent = '';
                sorted.textContent = '';
                return;
            }
            result.textContent = raw.split('').join(' ');
            sorted.textContent = 'Sorted: ' + raw.split('').sort().join(' ') + '  (' + raw.length + ' letters)';
        }

        function shuffleAnagram() {
            const input = document.getElementById('anagramInput');
            const letters = input.value.replace(/[^a-zA-Z]/g, '').toUpperCase().split('');
            // Fisher-Yates shuffle
            for (let i = letters.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [letters[i], letters[j]] = [letters[j], letters[i]];
            }
            input.value = letters.join('');
            updateAnagramDisplay();
        }

        function sortAnagram() {
            const input = document.getElementById('anagramInput');
            const letters = input.value.replace(/[^a-zA-Z]/g, '').toUpperCase().split('').sort();
            input.value = letters.join('');
            updateAnagramDisplay();
        }

        function clearAnagram() {
            document.getElementById('anagramInput').value = '';
            updateAnagramDisplay();
            document.getElementById('anagramInput').focus();
        }

        loadPuzzle();
    </script>
</body>
</html>
