<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guardian Cryptic Crossword</title>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background: #f8f9fa;
        }
        
        .header {
            background: white;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 200;
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            text-align: center;
        }
        
        h1 {
            margin: 0 0 5px 0;
            color: #1a1a1a;
            font-size: 24px;
        }
        
        .puzzle-info {
            color: #666;
            font-size: 14px;
        }
        
        .main-container {
            display: flex;
            max-width: 1400px;
            margin: 0 auto;
            gap: 0;
        }
        
        /* Grid Sidebar - Fixed */
        .grid-sidebar {
            width: 380px;
            background: white;
            box-shadow: 2px 0 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 80px;
            height: calc(100vh - 80px);
            overflow-y: auto;
            padding: 15px;
        }
        
        .grid-title {
            font-size: 12px;
            font-weight: 600;
            color: #666;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .grid-wrapper {
            text-align: center;
            overflow: auto;
        }
        
        .crossword-grid {
            display: inline-grid;
            gap: 0;
            border: 2px solid #000;
            background: #000;
            margin: 0 auto;
        }
        
        .cell {
            width: 22px;
            height: 22px;
            border: 1px solid #888;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 11px;
            font-family: 'Arial', sans-serif;
            background: #fff;
        }
        
        .cell.black {
            background: #1a1a1a;
        }
        
        .cell.filled {
            color: #1976d2;
            font-weight: 700;
        }
        
        .cell.highlighted {
            background: #bbdefb !important;
        }
        
        .cell-number {
            position: absolute;
            top: 1px;
            left: 1px;
            font-size: 5px;
            font-weight: normal;
            color: #000;
        }
        
        .cell-letter {
            margin-top: 1px;
            font-size: 10px;
        }
        
        /* Clues Section */
        .clues-main {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }
        
        .direction-section {
            margin-bottom: 40px;
        }
        
        .direction-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #1a1a1a;
            padding-bottom: 10px;
            border-bottom: 2px solid #2196f3;
        }
        
        .clue-item {
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: box-shadow 0.2s;
        }
        
        .clue-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .clue-header {
            margin-bottom: 15px;
        }
        
        .clue-number {
            display: inline-block;
            min-width: 35px;
            font-weight: 700;
            color: #2196f3;
            font-size: 16px;
        }
        
        .clue-text {
            font-size: 16px;
            color: #333;
            line-height: 1.6;
        }
        
        .enumeration {
            color: #999;
            font-size: 14px;
            margin-left: 8px;
        }
        
        /* Answer Input */
        .answer-section {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e0e0e0;
        }
        
        .answer-boxes {
            display: flex;
            gap: 4px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        .answer-box {
            width: 32px;
            height: 32px;
            border: 2px solid #bbb;
            border-radius: 4px;
            text-align: center;
            font-size: 16px;
            font-weight: 600;
            text-transform: uppercase;
            outline: none;
            font-family: 'Arial', sans-serif;
        }
        
        .answer-box:focus {
            border-color: #2196f3;
            background: #e3f2fd;
        }
        
        .answer-box.correct {
            background: #c8e6c9;
            border-color: #4caf50;
        }
        
        .answer-box.prefilled {
            background: #fff9c4;
            border-color: #fbc02d;
            color: #f57f17;
        }
        
        .answer-box.separator {
            width: 8px;
            border: none;
            pointer-events: none;
        }
        
        .check-button {
            padding: 8px 18px;
            background: #2196f3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: background 0.2s;
        }
        
        .check-button:hover {
            background: #1976d2;
        }
        
        .check-button.correct {
            background: #4caf50;
            cursor: default;
        }
        
        /* Hints */
        .hints-section {
            margin-top: 12px;
        }
        
        .hint-button {
            display: block;
            width: 100%;
            padding: 8px 16px;
            margin-bottom: 8px;
            background: #ff9800;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            text-align: left;
            transition: background 0.2s;
        }
        
        .hint-button:hover {
            background: #f57c00;
        }
        
        .hint-button.revealed {
            background: #ffa726;
        }
        
        .hint-text {
            margin-top: 8px;
            margin-bottom: 12px;
            padding: 12px;
            background: #fff3e0;
            border-left: 3px solid #ff9800;
            border-radius: 4px;
            font-size: 14px;
            line-height: 1.6;
            display: none;
        }
        
        .hint-text.visible {
            display: block;
        }
        
        .feedback {
            margin-top: 10px;
            padding: 8px;
            border-radius: 4px;
            font-size: 13px;
            display: none;
        }
        
        .feedback.visible {
            display: block;
        }
        
        .feedback.correct {
            background: #c8e6c9;
            color: #2e7d32;
            font-weight: 500;
        }
        
        .feedback.incorrect {
            background: #ffcdd2;
            color: #c62828;
        }
        
        @media (max-width: 1024px) {
            .main-container {
                flex-direction: column;
            }
            
            .grid-sidebar {
                width: 100%;
                position: relative;
                height: auto;
                top: 0;
            }
            
            .crossword-grid {
                transform: scale(0.7);
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>Guardian Cryptic Crossword</h1>
            <div class="puzzle-info" id="puzzleInfo">Loading...</div>
        </div>
    </div>
    
    <div class="main-container">
        <!-- Grid Sidebar -->
        <div class="grid-sidebar" id="gridSidebar" style="display: none;">
            <div class="grid-title">GRID</div>
            <div class="grid-wrapper">
                <div id="crosswordGrid"></div>
            </div>
        </div>
        
        <!-- Clues Main Area -->
        <div class="clues-main">
            <div class="direction-section">
                <h2 class="direction-title">Across</h2>
                <div id="cluesAcross"></div>
            </div>
            
            <div class="direction-section">
                <h2 class="direction-title">Down</h2>
                <div id="cluesDown"></div>
            </div>
        </div>
    </div>

    <script>
        const puzzleNumber = window.location.pathname.split('/').pop();
        let puzzleData = null;
        let userAnswers = {}; // {clueId: 'ANSWER'}
        let gridFills = {}; // {x,y: letter}
        let hintsRevealed = {}; // {clueId: [1,2,3,4]}

        async function loadPuzzle() {
            try {
                console.log('Loading puzzle:', puzzleNumber);
                const response = await fetch(`/api/puzzle/${puzzleNumber}`);
                puzzleData = await response.json();
                
                console.log('Puzzle data:', puzzleData);
                
                if (puzzleData.error) {
                    alert('Puzzle not found');
                    return;
                }
                
                document.getElementById('puzzleInfo').innerHTML = 
                    `#${puzzleData.puzzle_number} by ${puzzleData.setter} | ${puzzleData.date}`;
                
                // Show grid if available
                if (puzzleData.grid && puzzleData.grid.grid) {
                    console.log('Grid available, rendering...');
                    document.getElementById('gridSidebar').style.display = 'block';
                    renderGrid();
                } else {
                    console.warn('No grid data available');
                }
                
                // Show loading message
                document.getElementById('cluesAcross').innerHTML = '<p>Loading hints...</p>';
                document.getElementById('cluesDown').innerHTML = '<p>Loading hints...</p>';
                
                // Fetch hints for each clue
                await fetchHints();
                
                console.log('Rendering clues...');
                renderClues();
            } catch (error) {
                console.error('Error:', error);
                alert('Error loading puzzle: ' + error.message);
            }
        }

        async function fetchHints() {
            console.log('Fetching hints for clues...');
            for (let clue of puzzleData.clues) {
                try {
                    console.log(`Fetching hints for clue ${clue.id}`);
                    const response = await fetch(`/api/clue/${clue.id}/hints`);
                    if (!response.ok) {
                        console.error(`Failed to fetch hints for clue ${clue.id}: ${response.status}`);
                        clue.hints = ['', '', '', ''];
                        continue;
                    }
                    const data = await response.json();
                    clue.hints = data.hints || ['', '', '', ''];
                    console.log(`Got hints for clue ${clue.id}:`, clue.hints);
                } catch (error) {
                    console.error(`Error fetching hints for clue ${clue.id}:`, error);
                    clue.hints = ['', '', '', ''];
                }
            }
            console.log('Finished fetching hints');
        }

        function renderGrid() {
            const grid = puzzleData.grid;
            const size = grid.size || 15;
            const container = document.getElementById('crosswordGrid');
            container.className = 'crossword-grid';
            container.style.gridTemplateColumns = `repeat(${size}, 22px)`;
            container.innerHTML = '';
            
            for (let y = 0; y < size; y++) {
                for (let x = 0; x < size; x++) {
                    const letter = grid.grid[y][x];
                    const number = grid.numbers[y][x];
                    const isBlack = letter === null;
                    
                    const cell = document.createElement('div');
                    cell.className = `cell ${isBlack ? 'black' : 'white'}`;
                    cell.dataset.x = x;
                    cell.dataset.y = y;
                    
                    if (!isBlack) {
                        if (number) {
                            const numSpan = document.createElement('span');
                            numSpan.className = 'cell-number';
                            numSpan.textContent = number;
                            cell.appendChild(numSpan);
                        }
                        
                        const letterSpan = document.createElement('span');
                        letterSpan.className = 'cell-letter';
                        letterSpan.dataset.x = x;
                        letterSpan.dataset.y = y;
                        
                        const key = `${x},${y}`;
                        if (gridFills[key]) {
                            letterSpan.textContent = gridFills[key];
                            cell.classList.add('filled');
                        }
                        
                        cell.appendChild(letterSpan);
                    }
                    
                    container.appendChild(cell);
                }
            }
        }

        function updateGrid(clueId, answer) {
            const cells = puzzleData.grid.clue_cells[clueId] || [];
            
            cells.forEach(([x, y], index) => {
                const key = `${x},${y}`;
                gridFills[key] = answer[index];
                
                const letterSpan = document.querySelector(`.cell-letter[data-x="${x}"][data-y="${y}"]`);
                if (letterSpan) {
                    letterSpan.textContent = answer[index];
                    letterSpan.parentElement.classList.add('filled');
                }
            });
            
            // Update other clues' answer boxes that share these cells
            updateCrossFilledLetters();
        }

        function updateCrossFilledLetters() {
            puzzleData.clues.forEach(clue => {
                const clueId = `${clue.clue_number}-${clue.direction}`;
                const cells = puzzleData.grid.clue_cells[clueId] || [];
                
                cells.forEach(([ x, y], index) => {
                    const key = `${x},${y}`;
                    if (gridFills[key]) {
                        const input = document.querySelector(
                            `.answer-box[data-clue-id="${clueId}"][data-index="${index}"]`
                        );
                        if (input && !input.value) {
                            input.value = gridFills[key];
                            input.classList.add('prefilled');
                            input.disabled = true;
                        }
                    }
                });
            });
        }

        function renderClues() {
            const acrossClues = puzzleData.clues.filter(c => c.direction === 'across');
            const downClues = puzzleData.clues.filter(c => c.direction === 'down');
            
            document.getElementById('cluesAcross').innerHTML = acrossClues
                .map(clue => createClueElement(clue))
                .join('');
            
            document.getElementById('cluesDown').innerHTML = downClues
                .map(clue => createClueElement(clue))
                .join('');
            
            setupEventListeners();
        }

        function createClueElement(clue) {
            const clueId = `${clue.clue_number}-${clue.direction}`;
            const length = parseInt(clue.enumeration.replace(/[^0-9]/g, '')) || clue.answer.length;
            
            // Parse enumeration for separators
            const enumParts = clue.enumeration.match(/\d+/g) || [clue.answer.length];
            let boxesHTML = '';
            let totalBoxes = 0;
            
            enumParts.forEach((part, partIndex) => {
                const count = parseInt(part);
                for (let i = 0; i < count; i++) {
                    boxesHTML += `<input type="text" maxlength="1" 
                        class="answer-box" 
                        data-clue-id="${clueId}" 
                        data-index="${totalBoxes}"
                        oninput="handleAnswerInput('${clueId}', ${totalBoxes}, this.value)"
                        onkeydown="handleAnswerKeydown(event, '${clueId}', ${totalBoxes})">`;
                    totalBoxes++;
                }
                if (partIndex < enumParts.length - 1) {
                    boxesHTML += '<div class="answer-box separator"></div>';
                }
            });
            
            return `
                <div class="clue-item" data-clue-id="${clueId}">
                    <div class="clue-header">
                        <div>
                            <span class="clue-number">${clue.clue_number}</span>
                            <span class="clue-text">${clue.clue_text}</span>
                            <span class="enumeration">(${clue.enumeration})</span>
                        </div>
                    </div>
                    
                    <div class="answer-section">
                        <div class="answer-label">Your answer:</div>
                        <div class="answer-boxes">${boxesHTML}</div>
                        <button class="check-button" onclick="checkAnswer('${clueId}', '${clue.answer}')">
                            Check Answer
                        </button>
                        <div class="feedback" id="feedback-${clueId}"></div>
                    </div>
                    
                    <div class="hints-section">
                        <button class="hint-button" onclick="revealHint('${clueId}', 1)">Hint 1</button>
                        <div class="hint-text" id="hint-${clueId}-1">${clue.hints[0] || 'No hint available'}</div>
                        
                        <button class="hint-button" onclick="revealHint('${clueId}', 2)">Hint 2</button>
                        <div class="hint-text" id="hint-${clueId}-2">${clue.hints[1] || 'No hint available'}</div>
                        
                        <button class="hint-button" onclick="revealHint('${clueId}', 3)">Hint 3</button>
                        <div class="hint-text" id="hint-${clueId}-3">${clue.hints[2] || 'No hint available'}</div>
                        
                        <button class="hint-button" onclick="revealHint('${clueId}', 4)">Hint 4</button>
                        <div class="hint-text" id="hint-${clueId}-4">${clue.hints[3] || 'No hint available'}</div>
                    </div>
                </div>
            `;
        }

        function handleAnswerInput(clueId, index, value) {
            if (value) {
                value = value.toUpperCase();
                const input = document.querySelector(
                    `.answer-box[data-clue-id="${clueId}"][data-index="${index}"]`
                );
                input.value = value;
                
                // Auto-advance
                const nextInput = document.querySelector(
                    `.answer-box[data-clue-id="${clueId}"][data-index="${index + 1}"]`
                );
                if (nextInput) {
                    nextInput.focus();
                }
            }
        }

        function handleAnswerKeydown(event, clueId, index) {
            if (event.key === 'Backspace') {
                const input = event.target;
                if (!input.value) {
                    const prevInput = document.querySelector(
                        `.answer-box[data-clue-id="${clueId}"][data-index="${index - 1}"]`
                    );
                    if (prevInput) {
                        prevInput.focus();
                        prevInput.value = '';
                    }
                }
            }
        }

        function checkAnswer(clueId, correctAnswer) {
            const inputs = document.querySelectorAll(`.answer-box[data-clue-id="${clueId}"]:not(.separator)`);
            let userAnswer = '';
            
            inputs.forEach(input => {
                userAnswer += input.value.toUpperCase() || '';
            });
            
            const feedback = document.getElementById(`feedback-${clueId}`);
            
            if (userAnswer === correctAnswer.toUpperCase()) {
                feedback.textContent = '✓ Correct!';
                feedback.className = 'feedback correct visible';
                
                // Fill grid
                updateGrid(clueId, correctAnswer.toUpperCase());
                
                // Mark inputs as correct
                inputs.forEach(input => {
                    input.classList.add('correct');
                    input.disabled = true;
                });
                
                // Update button
                const button = document.querySelector(`button[onclick*="${clueId}"]`);
                button.textContent = '✓ Correct';
                button.classList.add('correct');
                button.disabled = true;
                
            } else {
                feedback.textContent = '✗ Not quite right. Try again or use a hint!';
                feedback.className = 'feedback incorrect visible';
                
                setTimeout(() => {
                    feedback.classList.remove('visible');
                }, 3000);
            }
        }

        function revealHint(clueId, level) {
            const hint = document.getElementById(`hint-${clueId}-${level}`);
            hint.classList.add('visible');
            
            // Mark button as revealed
            const buttons = document.querySelectorAll(`button[onclick*="${clueId}"]`);
            if (buttons[level - 1]) {
                buttons[level - 1].classList.add('revealed');
            }
        }

        function setupEventListeners() {
            // Auto-focus first answer box when scrolling to clue
        }

        loadPuzzle();
    </script>
</body>
</html>
