<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guardian Cryptic Crossword</title>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f8f9fa;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        h1 {
            margin: 0 0 10px 0;
            color: #1a1a1a;
        }
        
        .puzzle-info {
            color: #666;
            font-size: 14px;
        }
        
        .content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
        }
        
        .grid-section {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .crossword-grid {
            display: inline-grid;
            gap: 0;
            border: 2px solid #000;
            background: #000;
            margin: 0 auto;
        }
        
        .grid-wrapper {
            text-align: center;
        }
        
        .cell {
            width: 36px;
            height: 36px;
            border: 1px solid #888;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 16px;
            font-family: 'Arial', sans-serif;
            cursor: pointer;
            transition: all 0.15s;
            background: #fff;
        }
        
        .cell.black {
            background: #1a1a1a;
            cursor: default;
        }
        
        .cell.white:hover {
            background: #e3f2fd;
        }
        
        .cell.selected {
            background: #ffd54f !important;
            box-shadow: inset 0 0 0 2px #ff6f00;
        }
        
        .cell.highlighted {
            background: #90caf9 !important;
        }
        
        .cell-number {
            position: absolute;
            top: 1px;
            left: 2px;
            font-size: 8px;
            font-weight: normal;
            color: #000;
        }
        
        .cell-letter {
            font-size: 18px;
            color: #000;
            margin-top: 2px;
        }
        
        .clues-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            max-height: 800px;
            overflow-y: auto;
        }
        
        .clues-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #1a1a1a;
        }
        
        .clue-item {
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .clue-item:hover {
            background: #f5f5f5;
        }
        
        .clue-item.active {
            background: #e3f2fd;
            border-left: 3px solid #2196f3;
        }
        
        .clue-number {
            font-weight: 600;
            color: #2196f3;
            margin-right: 8px;
        }
        
        .clue-text {
            color: #333;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .error {
            text-align: center;
            padding: 40px;
            color: #d32f2f;
        }
        
        @media (max-width: 1024px) {
            .content {
                grid-template-columns: 1fr;
            }
            
            .cell {
                width: 30px;
                height: 30px;
                font-size: 14px;
            }
            
            .cell-number {
                font-size: 7px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Guardian Cryptic Crossword</h1>
            <div class="puzzle-info" id="puzzleInfo">Loading...</div>
        </div>
        
        <div class="content">
            <div class="grid-section">
                <div class="grid-wrapper">
                    <div id="crosswordGrid" class="loading">
                        Loading grid...
                    </div>
                </div>
            </div>
            
            <div class="clues-section">
                <div class="clues-title">Across</div>
                <div id="cluesAcross"></div>
                
                <div class="clues-title" style="margin-top: 20px;">Down</div>
                <div id="cluesDown"></div>
            </div>
        </div>
    </div>

    <script>
        const puzzleNumber = window.location.pathname.split('/').pop();
        
        let puzzleData = null;
        let selectedClue = null;

        async function loadPuzzle() {
            try {
                const response = await fetch(`/api/puzzle/${puzzleNumber}`);
                puzzleData = await response.json();
                
                if (puzzleData.error) {
                    document.getElementById('crosswordGrid').innerHTML = 
                        '<div class="error">Puzzle not found</div>';
                    return;
                }
                
                document.getElementById('puzzleInfo').innerHTML = 
                    `#${puzzleData.puzzle_number} by ${puzzleData.setter} | ${puzzleData.date}`;
                
                renderGrid();
                renderClues();
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('crosswordGrid').innerHTML = 
                    '<div class="error">Error loading puzzle</div>';
            }
        }

        function renderGrid() {
            const grid = puzzleData.grid;
            
            if (!grid || !grid.grid) {
                document.getElementById('crosswordGrid').innerHTML = 
                    '<div class="error">Grid not available</div>';
                return;
            }
            
            const size = grid.size || 15;
            const container = document.getElementById('crosswordGrid');
            container.className = 'crossword-grid';
            container.style.gridTemplateColumns = `repeat(${size}, 36px)`;
            container.innerHTML = '';
            
            for (let y = 0; y < size; y++) {
                for (let x = 0; x < size; x++) {
                    const letter = grid.grid[y][x];
                    const number = grid.numbers[y][x];
                    const cell = createCell(x, y, letter, number);
                    container.appendChild(cell);
                }
            }
        }

        function createCell(x, y, letter, number) {
            const isBlack = letter === null;
            const cell = document.createElement('div');
            cell.className = `cell ${isBlack ? 'black' : 'white'}`;
            cell.dataset.x = x;
            cell.dataset.y = y;
            
            if (!isBlack) {
                cell.onclick = () => handleCellClick(x, y);
                
                if (number) {
                    const numSpan = document.createElement('span');
                    numSpan.className = 'cell-number';
                    numSpan.textContent = number;
                    cell.appendChild(numSpan);
                }
                
                const letterSpan = document.createElement('span');
                letterSpan.className = 'cell-letter';
                letterSpan.textContent = letter;
                cell.appendChild(letterSpan);
            }
            
            return cell;
        }

        function handleCellClick(x, y) {
            const cellKey = `${x},${y}`;
            const clues = puzzleData.grid.cell_clues?.[cellKey] || [];
            
            if (clues.length === 0) return;
            
            // Toggle between across/down if cell has both
            let clueId = clues[0];
            if (clues.length > 1 && selectedClue === clues[0]) {
                clueId = clues[1];
            }
            
            selectClue(clueId);
        }

        function selectClue(clueId) {
            selectedClue = clueId;
            highlightClue(clueId);
            
            // Highlight clue in list
            document.querySelectorAll('.clue-item').forEach(item => {
                item.classList.remove('active');
            });
            const clueElement = document.querySelector(`[data-clue-id="${clueId}"]`);
            if (clueElement) {
                clueElement.classList.add('active');
                clueElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        function highlightClue(clueId) {
            const cluePositions = puzzleData.grid.clue_cells[clueId] || [];
            
            document.querySelectorAll('.cell').forEach(cell => {
                cell.classList.remove('highlighted', 'selected');
            });
            
            cluePositions.forEach(([x, y]) => {
                const cell = document.querySelector(`.cell[data-x="${x}"][data-y="${y}"]`);
                if (cell) {
                    cell.classList.add('highlighted');
                }
            });
        }

        function renderClues() {
            const acrossClues = puzzleData.clues.filter(c => c.direction === 'across');
            const downClues = puzzleData.clues.filter(c => c.direction === 'down');
            
            document.getElementById('cluesAcross').innerHTML = acrossClues
                .map(clue => createClueElement(clue))
                .join('');
            
            document.getElementById('cluesDown').innerHTML = downClues
                .map(clue => createClueElement(clue))
                .join('');
            
            // Add click handlers
            document.querySelectorAll('.clue-item').forEach(item => {
                item.onclick = () => selectClue(item.dataset.clueId);
            });
        }

        function createClueElement(clue) {
            const clueId = `${clue.clue_number}-${clue.direction}`;
            return `
                <div class="clue-item" data-clue-id="${clueId}">
                    <span class="clue-number">${clue.clue_number}.</span>
                    <span class="clue-text">${clue.clue_text}</span>
                    <span style="color: #999; font-size: 12px;"> (${clue.enumeration})</span>
                </div>
            `;
        }

        loadPuzzle();
    </script>
</body>
</html>
